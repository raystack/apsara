name: Sync develop with main

on:
  # Trigger when a PR is merged to main
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-develop:
    # Only run if PR was merged (not just closed) and it was merged to main
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    name: Create PR to sync develop with main
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: develop
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
      
      - name: Fetch latest from remote
        run: |
          git fetch --prune
      
      - name: Check if sync needed
        id: check
        run: |
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            echo "[SKIPPED] develop is already up to date with main."
          else
            echo "sync_needed=true" >> $GITHUB_OUTPUT
            echo "[NEEDED] develop needs to be synced with main"
          fi

      - name: Create sync branch and PR
        if: steps.check.outputs.sync_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a new branch for the sync
          SYNC_BRANCH="chore/sync-develop-with-main-${GITHUB_SHA::8}"
          git checkout -b $SYNC_BRANCH
          
          # Try to merge main into the sync branch
          if git merge origin/main -m "chore: sync develop with main after #${{ github.event.pull_request.number }}"; then
            git push origin $SYNC_BRANCH
            
            # Create PR using GitHub CLI
            gh pr create \
              --base develop \
              --head $SYNC_BRANCH \
              --title "[BOT] chore: sync develop with main (after #${{ github.event.pull_request.number }})" \
              --body "Automated PR to sync develop with main branch after PR #${{ github.event.pull_request.number }} was merged to main." \
              --label "automated"
          else
            echo "[MERGE CONFLICT] Manual intervention needed"
            git merge --abort
            exit 1
          fi